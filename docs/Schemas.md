# Schemas

> I recommend you read ***everything*** before using schemas!

### What and why

Schemas are an alternative, more structured way to define files and use them.
Inspired by the mongoose package. Schemas give us a way to make a template for a set of similarly structured documents, a great use case would be a user schema. Generally recommended for flat documents.

Schemas introduce some restrictions on the operations available, this however does not mean you cant just .get the file and use methods you might need.

For example, rage selection is not available when using schemas since .get is not available but nothing is stopping you from doing this:

```js
const user = DB.get('users').schema({...});

user.create('GamBar', {...});

return DB.get('users.[:5]').data;
```

### Foot gun

Do note that defining a schema, creating a file and then updating it without the schema might introduce problems with validation! For example:

```js
const user = DB.get('users').schema({..., postalCode: String});

user.create('GamBar', {...});

// Postal code is now a number
DB.get('users.GamBar.postalCode').set(78943);

// This returns a validation error for postalCode
// update and create validate the whole object before doing anything
user.update('GamBar', {email: 'new@mail.com'});
```

> Be careful when manually using .set on schemas!  
> Don't shoot yourself in the foot!! 

---

### Schema

Schemas accept two arguments, a `blueprint` and an optional `options`.  
Schemas can be created on any folder meaning you can navigate to it using `.get`

#### Blueprints

Blueprints provide the outline for your document. There are a number of options you can define. I've spit the table in a couple of different groups for easier navigation.

---

##### Functional options:
| Modifier   | Description                                              | Default |
| ---------- | -------------------------------------------------------- | ------- |
| type       | Type of property (use type classes)                      |         |
| required   | If property is required or not                           | `false` |
| default    | Default value in case of absence                         |         |
| immutable  | Weather this field can be updated                        | `false` |
| omit       | Weather to include filed in returns from reads           |         |
| populate   | String defining the field's relationship (auto populate) (only in create and read) |
---

##### Validating options:
| Modifier   | Description                                    |
| ---------- | ---------------------------------------------- |
| minLength  | Checks if length is not less than the number   |
| maxLength  | Checks if length is not more than the number   |
| min        | Checks if value is not more than the number    |
| max        | Checks if value is not more than the number    |
| enum       | Checks if value is in the given array          |
| validate   | Callback to validate this filed                |
---

##### Transforming options:
| Modifier   | Description                                    | Default |
| ---------- | ---------------------------------------------- | ------- |
| trim       | If type is string, apply the trim method       | `false` |
| innerTrim  | If type is string, normalize whitespace        | `false` |
| toCase     | If type is string, transform to chosen case    |         |
| transform  | Callback to transform this field               |         |

---
#### Options

| Option     | Description                                              | Default |
| ---------- | -------------------------------------------------------- | ------- |
| idLength   | If autogenerated, defines the length of the id           | `20`    |
| timestamps | When true, adds `created_at` and `updated_at` fields     | `false` |
---

**Example:**
```js
// schemas/user.js
const users = db.get('users').schema(
  {
    name: {
      type: String,
      trim: true,
      required: true,
    },
    lastName: {
      type: String,
      trim: true,
      default: '',
    },
    email: {
      type: String,
      required: true,
    },
    password: {
      type: String,
      required: true,
      omit: true,
      transform: (value) => bcrypt.hashSync(value, 10)
    },
  }, 
  { timestamps: true }
);

export default users;
```

> recommend use in separate file because of [hooks](#hooks)

---

### Hooks
Hooks give us the ability to execute code before and after a schema operation
There are `pre` and `post` hooks for every schema operation ([create](#create), [read](#read), [find](#find), [update](#update), [rename](#rename), [destroy](#destroy))

Generally, `pre` hooks provide the argument as a prop and the returned value is used as the value used internally and `post` hooks provide either the result or nothing as a prop. More details will be provided below

**Example:**

```js
users.hook('pre-create', user => ({
  ...user,
  password: bcrypt.hashSync(user.password, 10)
}));
```

```js
users.hook('post-destroy', () => {
  console.log('Entry destroyed!');
});
```

---
### Create
Creates a schema document (file)

| Parameter | Description                 | Default     |
| ----------| --------------------------- | ----------- |
| name      | Name of the file used as ID | `random ID` |
| object    | Object to save              |             |

**Example:**
```js
users.create('GamBar', {...});
```

```js
// Creating a document without a name assigns a semi-random ID
const [name, contents] = users.create({...});
// returns name and contents
```

**Hooks:**  
| Hook          | Provided value             |
| ------------- | -------------------------- |
| `pre-create`  | Value passed to function   |
| `post-create` | Final value from document  |
---
### Read
Display the contents of a file

| Parameter    | Description                 | Default     |
| ------------ | --------------------------- | ----------- |
| name         | Name of the file            |             |
| options.omit | Array with fields to omit   | `[]`        |

**Example:**
```js
users.read('GamBar');
// returns everything inside the file 'GamBar'
```

```js
users.read('GamBar', { omit: ['password'] });
// omits the password field
// this can be set in the blueprint as well
```

**Hooks:**  
| Hook        | Provided value             |
| ----------- | -------------------------- |
| `pre-read`  | Query passed to function   |
| `post-read` | Result from search         |

---
### Find
Find document with condition

| Parameter     | Description                                | Default     |
| --------------| ------------------------------------------ | ----------- |
| query         | Either a callback or object to search with |             |
| options.first | When `true` returns only the first find    | `false`     |

**Example:**
```js
users.find({ name: 'GamBar' }, { first: true });
// returns the first match of a document with the name GamBar
// without the first option it would return an array with every match
```

```js
users.find((doc) => doc.age >= 18);
// return every document with the value of age over 18 in an array
```

**Hooks:**  
| Hook        | Provided value             |
| ----------- | -------------------------- |
| `pre-find`  | Query passed to function   |
| `post-find` | Result from search         |

---
### Update
Update single document

| Parameter | Description                     |
| ----------| ------------------------------- |
| key       | Name or path to value to update |
| value     | Partial object to save          |

**Example:**
```js
users.update('GamBar', { age: 22 });
// returns error since age is not in the blueprint
```

```js
const newValue = users.update('GamBar', { lastName: "Bardon" });
// returns updated document
```

**Hooks:**  
| Hook          | Provided value             |
| ------------- | -------------------------- |
| `pre-update`  | Value passed to function   |
| `post-update` | Result from update         |

---
### Rename
Rename document (wrapper for .rename)

| Parameter | Description                     |
| ----------| ------------------------------- |
| oldName   | Current name of the document    |
| newName   | New name of the document        |

**Example:**
```js
users.rename('GamBar', 'Gamriel');
```

**Hooks:**  
| Hook          | Provided value |
| ------------- | -------------- |
| `pre-rename`  | oldName        |
| `post-rename` | newName        |

---
### Destroy
Delete single document

| Parameter | Description                 |
| ----------| --------------------------- |
| name      | Name of the file used as ID |

**Example:**
```js
users.destroy('GamBar');
```

**Hooks:**  
| Hook           | Provided value             |
| -------------- | -------------------------- |
| `pre-destroy`  | Value passed to function   |
| `post-destroy` | Document data              |

---

